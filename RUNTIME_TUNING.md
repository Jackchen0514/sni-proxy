# Tokio è¿è¡Œæ—¶æ€§èƒ½è°ƒä¼˜æŒ‡å—

## ğŸ¯ é—®é¢˜è¯Šæ–­

å¦‚æœæ‚¨å‘ç°è¿è¡Œæ—¶é…ç½®åæ€§èƒ½ä¸‹é™ï¼Œå¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š

### å¸¸è§æ€§èƒ½é—®é¢˜

1. **çº¿ç¨‹æ•°è¿‡å¤š**
   - ç—‡çŠ¶ï¼šCPU åˆ©ç”¨ç‡ä½ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹
   - åŸå› ï¼šI/O å¯†é›†å‹ä»»åŠ¡ä¸éœ€è¦å¤§é‡å·¥ä½œçº¿ç¨‹
   - è§£å†³ï¼šå‡å°‘å·¥ä½œçº¿ç¨‹æ•°

2. **çº¿ç¨‹æ ˆè¿‡å¤§**
   - ç—‡çŠ¶ï¼šå†…å­˜å ç”¨é«˜
   - åŸå› ï¼š2MB Ã— çº¿ç¨‹æ•° = è¿‡å¤šå†…å­˜
   - è§£å†³ï¼šä½¿ç”¨é»˜è®¤æ ˆå¤§å°ï¼ˆ~1MBï¼‰

3. **äº‹ä»¶é—´éš”è¿‡å¤§**
   - ç—‡çŠ¶ï¼šå“åº”å»¶è¿Ÿå¢åŠ 
   - åŸå› ï¼šI/O äº‹ä»¶è½®è¯¢ä¸å¤Ÿé¢‘ç¹
   - è§£å†³ï¼šé™ä½ event_interval

---

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### å½“å‰é…ç½®ï¼ˆå·²ä¼˜åŒ–ï¼‰

```rust
// I/O å¯†é›†å‹ä¼˜åŒ–é…ç½®
let worker_threads = std::cmp::max(4, num_cpus::get() / 2);

tokio::runtime::Builder::new_multi_thread()
    .worker_threads(worker_threads)      // 8 çº¿ç¨‹ (16æ ¸ç³»ç»Ÿ)
    .thread_name("sni-proxy-worker")
    // ä½¿ç”¨é»˜è®¤æ ˆå¤§å° (~1MB)
    .enable_all()
    .global_queue_interval(31)
    .event_interval(31)                  // é™ä½åˆ° 31 æé«˜å“åº”
    .build()?
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… I/O å¯†é›†å‹ï¼ˆæµåª’ä½“ä»£ç†ï¼‰
- âœ… é•¿è¿æ¥åœºæ™¯
- âœ… å¤§é‡å¹¶å‘è¿æ¥

**æ€§èƒ½ç‰¹ç‚¹**ï¼š
- ğŸ”» å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢
- ğŸ”» é™ä½å†…å­˜å ç”¨
- â¬†ï¸ æé«˜ I/O å“åº”é€Ÿåº¦

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### é…ç½®å¯¹æ¯”è¡¨

| é…ç½® | å·¥ä½œçº¿ç¨‹ | æ ˆå¤§å° | event_interval | é€‚ç”¨åœºæ™¯ |
|------|----------|--------|----------------|----------|
| **é»˜è®¤** | æ ¸å¿ƒæ•° | é»˜è®¤ | 61 | é€šç”¨ |
| **æ—§é…ç½®** | 16 | 2MB | 61 | CPU å¯†é›†å‹ |
| **å½“å‰é…ç½®** | 8 | é»˜è®¤ | 31 | I/O å¯†é›†å‹ âœ… |
| **æç®€é…ç½®** | 4 | é»˜è®¤ | 31 | ä½è´Ÿè½½ |

### å†…å­˜å ç”¨å¯¹æ¯”

| é…ç½® | çº¿ç¨‹æ ˆå†…å­˜ | è¯´æ˜ |
|------|-----------|------|
| æ—§é…ç½® | 16 Ã— 2MB = 32MB | è¿‡é«˜ |
| å½“å‰é…ç½® | 8 Ã— 1MB = 8MB | é€‚ä¸­ âœ… |
| æç®€é…ç½® | 4 Ã— 1MB = 4MB | æœ€ä½ |

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå½“å‰é…ç½®ï¼ˆæ¨èï¼‰

**é…ç½®**ï¼š
- å·¥ä½œçº¿ç¨‹ï¼šCPU æ ¸å¿ƒæ•° / 2 (æœ€å°‘ 4)
- æ ˆå¤§å°ï¼šé»˜è®¤
- äº‹ä»¶é—´éš”ï¼š31

**æµ‹è¯•æ­¥éª¤**ï¼š
```bash
# 1. ç¼–è¯‘
cargo build --release

# 2. å¯åŠ¨æœåŠ¡
./target/release/sni-proxy config.json

# 3. è§‚å¯Ÿæ—¥å¿—
ğŸš€ Tokio è¿è¡Œæ—¶é…ç½®:
  å·¥ä½œçº¿ç¨‹æ•°: 8 (CPU æ ¸å¿ƒ: 16 ç‰©ç†, 16 é€»è¾‘)
  çº¿ç¨‹æ ˆå¤§å°: é»˜è®¤ (~1MB)
  äº‹ä»¶é—´éš”: 31 (I/O å“åº”ä¼˜åŒ–)

# 4. ç›‘æ§æ€§èƒ½
# è§‚å¯Ÿ CPU ä½¿ç”¨ç‡
top -H -p $(pgrep sni-proxy)

# è§‚å¯Ÿä¸Šä¸‹æ–‡åˆ‡æ¢
pidstat -w -p $(pgrep sni-proxy) 1
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… CPU åˆ©ç”¨ç‡é€‚ä¸­ (40-60%)
- âœ… ä¸Šä¸‹æ–‡åˆ‡æ¢å‡å°‘
- âœ… å“åº”å»¶è¿Ÿé™ä½
- âœ… å†…å­˜å ç”¨é™ä½

---

### æ–¹æ¡ˆ Bï¼šæç®€é…ç½®ï¼ˆä½è´Ÿè½½åœºæ™¯ï¼‰

å¦‚æœå½“å‰é…ç½®ä»ç„¶æ…¢ï¼Œå°è¯•æ­¤é…ç½®ï¼š

**ä¿®æ”¹ `src/main.rs`**ï¼š
```rust
fn main() -> Result<()> {
    let runtime = tokio::runtime::Builder::new_multi_thread()
        .worker_threads(4)              // å›ºå®š 4 çº¿ç¨‹
        .thread_name("sni-proxy-worker")
        .enable_all()
        .global_queue_interval(31)
        .event_interval(31)
        .build()?;

    runtime.block_on(async_main())
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- å¹¶å‘è¿æ¥ < 1000
- å•æœºéƒ¨ç½²
- ä½è´Ÿè½½ç¯å¢ƒ

---

### æ–¹æ¡ˆ Cï¼šæœ€å¤§åŒ– I/O æ€§èƒ½

å¦‚æœéœ€è¦æè‡´ I/O æ€§èƒ½ï¼š

**ä¿®æ”¹ `src/main.rs`**ï¼š
```rust
fn main() -> Result<()> {
    let runtime = tokio::runtime::Builder::new_multi_thread()
        .worker_threads(4)
        .thread_name("sni-proxy-worker")
        .enable_all()
        .global_queue_interval(31)
        .event_interval(1)              // æœ€é¢‘ç¹çš„ I/O è½®è¯¢
        .build()?;

    runtime.block_on(async_main())
}
```

**è­¦å‘Š**ï¼š
- âš ï¸ å¢åŠ ç³»ç»Ÿè°ƒç”¨å¼€é”€
- âš ï¸ CPU ä½¿ç”¨ç‡ä¼šä¸Šå‡
- âœ… å»¶è¿Ÿæœ€ä½

---

### æ–¹æ¡ˆ Dï¼šå›é€€åˆ°é»˜è®¤é…ç½®

å¦‚æœè‡ªå®šä¹‰é…ç½®å¯¼è‡´é—®é¢˜ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ï¼š

**ä¿®æ”¹ `src/main.rs`**ï¼š
```rust
#[tokio::main]
async fn async_main() -> Result<()> {
    // ... åŸæœ‰ä»£ç 
}

fn main() -> Result<()> {
    // ç®€å•å¯åŠ¨ï¼ˆä½¿ç”¨é»˜è®¤è¿è¡Œæ—¶ï¼‰
    async_main()
}
```

æˆ–è€…ä¿æŒè‡ªå®šä¹‰è¿è¡Œæ—¶ä½†ä½¿ç”¨é»˜è®¤å‚æ•°ï¼š
```rust
fn main() -> Result<()> {
    let runtime = tokio::runtime::Builder::new_multi_thread()
        .enable_all()
        .build()?;

    runtime.block_on(async_main())
}
```

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†æµ‹è¯•

### æµ‹è¯•å·¥å…·

**1. è¿æ¥æµ‹è¯•**
```bash
# ä½¿ç”¨ wrk æµ‹è¯• HTTP ä»£ç†æ€§èƒ½
wrk -t4 -c100 -d30s https://example.com

# ä½¿ç”¨ ab æµ‹è¯•
ab -n 10000 -c 100 https://example.com/
```

**2. CPU åˆ†æ**
```bash
# å®æ—¶ç›‘æ§ CPU ä½¿ç”¨
top -H -p $(pgrep sni-proxy)

# æŸ¥çœ‹çº¿ç¨‹ CPU åˆ†å¸ƒ
ps -Lf -p $(pgrep sni-proxy) -o pid,tid,psr,pcpu,comm
```

**3. ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ†æ**
```bash
# ç›‘æ§ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆè¶Šä½è¶Šå¥½ï¼‰
pidstat -w -p $(pgrep sni-proxy) 1

# é¢„æœŸå€¼ï¼š
# cswch/s < 1000  (éå¸¸å¥½)
# cswch/s < 5000  (è‰¯å¥½)
# cswch/s > 10000 (éœ€è¦ä¼˜åŒ–)
```

**4. å»¶è¿Ÿæµ‹è¯•**
```bash
# ä½¿ç”¨ ping æµ‹è¯•å»¶è¿Ÿ
time curl -I https://example.com

# æŸ¥çœ‹è¿æ¥å»ºç«‹æ—¶é—´
curl -w "@curl-format.txt" -o /dev/null -s https://example.com

# curl-format.txt å†…å®¹ï¼š
# time_namelookup:  %{time_namelookup}\n
# time_connect:     %{time_connect}\n
# time_starttransfer: %{time_starttransfer}\n
# time_total:       %{time_total}\n
```

---

## ğŸ›ï¸ è°ƒä¼˜å‚æ•°è¯´æ˜

### 1. worker_threadsï¼ˆå·¥ä½œçº¿ç¨‹æ•°ï¼‰

**ä½œç”¨**ï¼šå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± å¤§å°

**é€‰æ‹©æŒ‡å—**ï¼š
```
I/O å¯†é›†å‹ï¼ˆæµåª’ä½“ä»£ç†ï¼‰:
- æ¨è: CPU æ ¸å¿ƒæ•° / 2 åˆ° 1/4
- èŒƒå›´: 4 - 8 çº¿ç¨‹
- åŸå› : I/O æ“ä½œä¸»è¦ç­‰å¾…ï¼Œä¸éœ€è¦å¤§é‡çº¿ç¨‹

CPU å¯†é›†å‹ï¼ˆåŠ å¯†ã€å‹ç¼©ï¼‰:
- æ¨è: CPU æ ¸å¿ƒæ•°
- èŒƒå›´: 8 - 16 çº¿ç¨‹
- åŸå› : éœ€è¦å……åˆ†åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›

æ··åˆè´Ÿè½½:
- æ¨è: CPU æ ¸å¿ƒæ•° Ã— 0.75
- èŒƒå›´: 6 - 12 çº¿ç¨‹
- åŸå› : å¹³è¡¡ I/O å’Œ CPU ä½¿ç”¨
```

**æµ‹è¯•æ–¹æ³•**ï¼š
```bash
# æµ‹è¯•ä¸åŒçº¿ç¨‹æ•°çš„æ€§èƒ½
for threads in 4 8 12 16; do
    echo "æµ‹è¯• $threads çº¿ç¨‹"
    # ä¿®æ”¹é…ç½®ï¼Œé‡å¯æœåŠ¡ï¼Œè¿è¡ŒåŸºå‡†æµ‹è¯•
    # è®°å½•ååé‡å’Œå»¶è¿Ÿ
done
```

---

### 2. event_intervalï¼ˆäº‹ä»¶é—´éš”ï¼‰

**ä½œç”¨**ï¼šè½®è¯¢ I/O äº‹ä»¶çš„é¢‘ç‡

**å‚æ•°è¯´æ˜**ï¼š
```
event_interval = 1:
- æ¯æ¬¡å¾ªç¯éƒ½è½®è¯¢ epoll/kqueue
- å»¶è¿Ÿæœ€ä½ï¼Œä½† CPU å¼€é”€æœ€é«˜
- é€‚åˆä½å»¶è¿Ÿè¦æ±‚

event_interval = 31:
- æ¯ 31 æ¬¡ä»»åŠ¡è½®è¯¢ä¸€æ¬¡
- å»¶è¿Ÿé€‚ä¸­ï¼ŒCPU å¼€é”€é€‚ä¸­
- æ¨èç”¨äºæµåª’ä½“ä»£ç† âœ…

event_interval = 61:
- æ¯ 61 æ¬¡ä»»åŠ¡è½®è¯¢ä¸€æ¬¡
- å»¶è¿Ÿç¨é«˜ï¼ŒCPU å¼€é”€æœ€ä½
- é€‚åˆä½è´Ÿè½½ç¯å¢ƒ
```

**æƒè¡¡**ï¼š
- å€¼è¶Šå°ï¼šå»¶è¿Ÿè¶Šä½ï¼Œä½† CPU ä½¿ç”¨ç‡è¶Šé«˜
- å€¼è¶Šå¤§ï¼šCPU æ•ˆç‡è¶Šé«˜ï¼Œä½†å»¶è¿Ÿè¶Šé«˜

---

### 3. global_queue_intervalï¼ˆå…¨å±€é˜Ÿåˆ—é—´éš”ï¼‰

**ä½œç”¨**ï¼šå·¥ä½œçªƒå–è°ƒåº¦å™¨çš„å…¬å¹³æ€§

**å‚æ•°è¯´æ˜**ï¼š
```
global_queue_interval = 10:
- ä»»åŠ¡åˆ†é…æ›´å…¬å¹³
- é€‚åˆä»»åŠ¡æ‰§è¡Œæ—¶é—´å·®å¼‚å¤§çš„åœºæ™¯

global_queue_interval = 31: (é»˜è®¤)
- å¹³è¡¡å…¬å¹³æ€§å’Œæ€§èƒ½
- æ¨èå€¼ âœ…

global_queue_interval = 100:
- æ€§èƒ½æœ€é«˜
- å¯èƒ½å¯¼è‡´ä»»åŠ¡åˆ†é…ä¸å‡
```

**å»ºè®®**ï¼šä¿æŒé»˜è®¤å€¼ 31

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ€§èƒ½ä»ç„¶æ…¢

**æ£€æŸ¥é¡¹**ï¼š
```bash
# 1. ç¡®è®¤ä½¿ç”¨ release æ„å»º
cargo build --release
./target/release/sni-proxy config.json

# 2. æ£€æŸ¥ CPU ä½¿ç”¨ç‡
top -p $(pgrep sni-proxy)
# å¦‚æœ CPU å¾ˆä½ï¼ˆ< 20%ï¼‰ï¼Œå‡å°‘çº¿ç¨‹æ•°
# å¦‚æœ CPU å¾ˆé«˜ï¼ˆ> 80%ï¼‰ï¼Œå¢åŠ çº¿ç¨‹æ•°

# 3. æ£€æŸ¥ä¸Šä¸‹æ–‡åˆ‡æ¢
pidstat -w -p $(pgrep sni-proxy) 1
# å¦‚æœ cswch/s > 10000ï¼Œå‡å°‘çº¿ç¨‹æ•°

# 4. æ£€æŸ¥å†…å­˜
ps aux | grep sni-proxy
# æ£€æŸ¥ RSSï¼ˆå†…å­˜ï¼‰æ˜¯å¦è¿‡é«˜
```

---

### é—®é¢˜ 2ï¼šå»¶è¿Ÿå¢åŠ 

**å¯èƒ½åŸå› **ï¼š
1. event_interval è¿‡å¤§
2. çº¿ç¨‹æ•°è¿‡å°‘
3. å…¨å±€é˜Ÿåˆ—é—´éš”ä¸åˆé€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```rust
// é™ä½ event_interval
.event_interval(1)  // æœ€æ¿€è¿›

// æˆ–è€…å¢åŠ çº¿ç¨‹æ•°
.worker_threads(num_cpus::get())
```

---

### é—®é¢˜ 3ï¼šCPU ä½¿ç”¨ç‡è¿‡é«˜

**å¯èƒ½åŸå› **ï¼š
1. event_interval è¿‡å°
2. çº¿ç¨‹æ•°è¿‡å¤š

**è§£å†³æ–¹æ¡ˆ**ï¼š
```rust
// å¢åŠ  event_interval
.event_interval(61)

// å‡å°‘çº¿ç¨‹æ•°
.worker_threads(4)
```

---

## ğŸ’¡ æ¨èé…ç½®æ€»ç»“

### å°å‹éƒ¨ç½²ï¼ˆ< 1000 è¿æ¥ï¼‰

```rust
tokio::runtime::Builder::new_multi_thread()
    .worker_threads(4)
    .enable_all()
    .event_interval(31)
    .build()?
```

### ä¸­å‹éƒ¨ç½²ï¼ˆ1000-5000 è¿æ¥ï¼‰

```rust
let worker_threads = std::cmp::max(4, num_cpus::get() / 2);

tokio::runtime::Builder::new_multi_thread()
    .worker_threads(worker_threads)
    .enable_all()
    .event_interval(31)
    .build()?
```

### å¤§å‹éƒ¨ç½²ï¼ˆ> 5000 è¿æ¥ï¼‰

```rust
tokio::runtime::Builder::new_multi_thread()
    .worker_threads(num_cpus::get())
    .enable_all()
    .event_interval(31)
    .build()?
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Tokio è°ƒä¼˜æŒ‡å—](https://tokio.rs/tokio/topics/tuning)
- [Tokio Runtime Builder API](https://docs.rs/tokio/latest/tokio/runtime/struct.Builder.html)
- [Linux Performance Analysis](https://www.brendangregg.com/linuxperf.html)

---

**æœ€åæ›´æ–°**: 2025-12-04
**ç‰ˆæœ¬**: 1.1.0
