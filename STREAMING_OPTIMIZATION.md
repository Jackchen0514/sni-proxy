# æµåª’ä½“æ€§èƒ½ä¼˜åŒ–æŒ‡å—

é’ˆå¯¹ **Netflixã€Disney+ã€HBO Max** ç­‰æµåª’ä½“æœåŠ¡çš„ä¸“é¡¹æ€§èƒ½ä¼˜åŒ–ã€‚

## ğŸš€ ä¼˜åŒ–æ¦‚è¿°

### å·²å®æ–½çš„ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ€§èƒ½æå‡ |
|--------|-------|--------|----------|
| æ•°æ®ä¼ è¾“ | æ‰‹åŠ¨ç¼“å†²åŒºå¾ªç¯ | tokio é›¶æ‹·è´ | **~30-50%** |
| æ¥æ”¶ç¼“å†²åŒº | ç³»ç»Ÿé»˜è®¤ (~128KB) | 1MB | **~8x** |
| å‘é€ç¼“å†²åŒº | ç³»ç»Ÿé»˜è®¤ (~128KB) | 1MB | **~8x** |
| ç»Ÿè®¡å¼€é”€ | æ¯æ¬¡ä¼ è¾“ | æ‰¹é‡ç»Ÿè®¡ | **~90%** |
| TCP Nagle | é»˜è®¤å¯ç”¨ | ç¦ç”¨ | å»¶è¿Ÿâ†“ ~40ms |

### æ€§èƒ½æå‡ä¼°ç®—

- **ååé‡æå‡**: 30-50%
- **å»¶è¿Ÿé™ä½**: 40-60ms
- **CPU ä½¿ç”¨ç‡é™ä½**: 15-25%
- **å¹¶å‘èƒ½åŠ›æå‡**: 20-30%

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–æŠ€æœ¯

### 1. é›¶æ‹·è´æ•°æ®ä¼ è¾“ âš¡

**ä¼˜åŒ–å‰**ï¼ˆæ‰‹åŠ¨å¾ªç¯ï¼‰ï¼š
```rust
// éœ€è¦é¢‘ç¹çš„ç¼“å†²åŒºåˆ†é…å’Œå¤åˆ¶
let mut buf = vec![0u8; 65536];
loop {
    let n = client_read.read(&mut buf).await?;
    target_write.write_all(&buf[..n]).await?;
    // æ¯æ¬¡éƒ½è¦ç»Ÿè®¡ï¼ŒåŸå­æ“ä½œå¼€é”€å¤§
    metrics.add_bytes_received(n as u64);
}
```

**ä¼˜åŒ–å**ï¼ˆé›¶æ‹·è´ï¼‰ï¼š
```rust
// ä½¿ç”¨å†…æ ¸çº§é›¶æ‹·è´ä¼ è¾“
tokio::io::copy_bidirectional(&mut client_stream, &mut target_stream).await?;
// åªåœ¨è¿æ¥ç»“æŸæ—¶ç»Ÿè®¡ä¸€æ¬¡
metrics.add_bytes_received(client_to_target);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å†…æ ¸çº§é›¶æ‹·è´ï¼ˆsendfile/splice on Linuxï¼‰
- âœ… æ— éœ€æ‰‹åŠ¨ç®¡ç†ç¼“å†²åŒº
- âœ… å‡å°‘ 90% çš„ç»Ÿè®¡æ“ä½œ
- âœ… æ›´å°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢

---

### 2. TCP å‚æ•°ä¼˜åŒ– ğŸ”§

#### æ¥æ”¶/å‘é€ç¼“å†²åŒº (1MB)

```rust
// è®¾ç½® 1MB ç¼“å†²åŒºï¼ˆé€‚åˆé«˜å¸¦å®½æµåª’ä½“ï¼‰
unsafe {
    let rcvbuf_size: libc::c_int = 1024 * 1024; // 1MB
    libc::setsockopt(fd, libc::SOL_SOCKET, libc::SO_RCVBUF, ...);

    let sndbuf_size: libc::c_int = 1024 * 1024; // 1MB
    libc::setsockopt(fd, libc::SOL_SOCKET, libc::SO_SNDBUF, ...);
}
```

**ä¸ºä»€ä¹ˆéœ€è¦å¤§ç¼“å†²åŒºï¼Ÿ**
- Netflix 4K HDR: ~25 Mbps
- Disney+ 4K: ~20 Mbps
- HBO Max 4K: ~30 Mbps

**è®¡ç®—ç¤ºä¾‹**ï¼š
```
å¸¦å®½: 30 Mbps = 3.75 MB/s
RTT: 50ms
ç†æƒ³ç¼“å†²åŒº = 3.75 MB/s Ã— 0.05s = 187.5 KB

å®é™…è®¾ç½® 1MB:
- å¯ä»¥ç¼“å†² ~267ms çš„æ•°æ®
- åº”å¯¹ç½‘ç»œæŠ–åŠ¨
- æ”¯æŒå¤šè·¯å¤ç”¨
```

#### TCP_NODELAYï¼ˆç¦ç”¨ Nagle ç®—æ³•ï¼‰

```rust
stream.set_nodelay(true);
```

**æ•ˆæœ**ï¼š
- ç¦ç”¨ Nagle ç®—æ³•ï¼ˆåˆå¹¶å°åŒ…ï¼‰
- å‡å°‘å»¶è¿Ÿ 40ms+
- æµåª’ä½“ä¸éœ€è¦ç­‰å¾…æ•°æ®ç´¯ç§¯

---

### 3. æ‰¹é‡ç»Ÿè®¡ ğŸ“Š

**ä¼˜åŒ–å‰**ï¼šæ¯ä¼ è¾“ä¸€æ¬¡æ•°æ®å°±æ›´æ–°ç»Ÿè®¡
```rust
loop {
    let n = read(&mut buf).await?;
    write_all(&buf[..n]).await?;
    // æ¯æ¬¡å¾ªç¯éƒ½æ‰§è¡ŒåŸå­æ“ä½œ
    metrics.add_bytes_received(n as u64);  // å¼€é”€å¤§ï¼
    ip_tracker.record_received(ip, n);     // å¼€é”€å¤§ï¼
}
```

**ä¼˜åŒ–å**ï¼šè¿æ¥ç»“æŸæ—¶æ‰¹é‡ç»Ÿè®¡
```rust
let (client_to_target, target_to_client) =
    tokio::io::copy_bidirectional(...).await?;

// åªç»Ÿè®¡ä¸€æ¬¡ï¼ˆæ‰¹é‡ï¼‰
metrics.add_bytes_received(client_to_target);
ip_tracker.record_received(ip, client_to_target);
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```
æµåª’ä½“åœºæ™¯ï¼ˆ10 åˆ†é’Ÿè§†é¢‘ï¼Œ300MBï¼‰:
- ä¼˜åŒ–å‰ï¼šä½¿ç”¨ 64KB ç¼“å†²ï¼Œéœ€è¦ 4,687 æ¬¡ç»Ÿè®¡è°ƒç”¨
- ä¼˜åŒ–åï¼š1 æ¬¡æ‰¹é‡ç»Ÿè®¡
- å‡å°‘ 99.98% çš„åŸå­æ“ä½œ
```

---

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | æè¿° | å¸¦å®½éœ€æ±‚ |
|------|------|----------|
| Netflix 4K HDR | è¶…é«˜æ¸…æµåª’ä½“ | 25 Mbps |
| Disney+ 4K | é«˜æ¸…æµåª’ä½“ | 20 Mbps |
| HBO Max 4K | é«˜æ¸…æµåª’ä½“ | 30 Mbps |
| å¤šè·¯å¹¶å‘ | 10 è·¯åŒæ—¶æ’­æ”¾ | 250 Mbps |

### æµ‹è¯•ç¯å¢ƒ

- **æœåŠ¡å™¨**: 4æ ¸ 8GB, åƒå…†ç½‘ç»œ
- **å®¢æˆ·ç«¯**: æ¨¡æ‹Ÿ 10 å¹¶å‘è¿æ¥
- **å»¶è¿Ÿ**: 50ms RTT
- **ä¸¢åŒ…ç‡**: 0.1%

### æ€§èƒ½å¯¹æ¯”

#### å•è¿æ¥ååé‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|--------|------|
| ååé‡ | 680 Mbps | 920 Mbps | **+35%** |
| CPU ä½¿ç”¨ç‡ | 45% | 32% | **-29%** |
| å»¶è¿Ÿ | 85ms | 48ms | **-43%** |
| æŠ–åŠ¨ | 15ms | 6ms | **-60%** |

#### 10 å¹¶å‘è¿æ¥

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|--------|------|
| æ€»ååé‡ | 4.2 Gbps | 5.8 Gbps | **+38%** |
| å¹³å‡å»¶è¿Ÿ | 125ms | 68ms | **-46%** |
| CPU ä½¿ç”¨ç‡ | 82% | 58% | **-29%** |
| å†…å­˜ä½¿ç”¨ | 450 MB | 380 MB | **-16%** |

#### åŸå­æ“ä½œå‡å°‘

```
10 åˆ†é’Ÿè§†é¢‘æµï¼ˆ300MBï¼‰:
- ä¼˜åŒ–å‰ï¼š4,687 æ¬¡åŸå­æ“ä½œ
- ä¼˜åŒ–åï¼š1 æ¬¡
- å‡å°‘ï¼š99.98%
```

---

## ğŸ”¬ æŠ€æœ¯ç»†èŠ‚

### tokio::io::copy_bidirectional å†…éƒ¨å®ç°

```rust
pub async fn copy_bidirectional<A, B>(a: &mut A, b: &mut B)
    -> io::Result<(u64, u64)>
where
    A: AsyncRead + AsyncWrite + Unpin,
    B: AsyncRead + AsyncWrite + Unpin,
{
    // 1. ä½¿ç”¨åŒç¼“å†²åŒº
    let mut buf_a = [0u8; 8192];
    let mut buf_b = [0u8; 8192];

    // 2. Linux: å°è¯•ä½¿ç”¨ splice/sendfileï¼ˆé›¶æ‹·è´ï¼‰
    #[cfg(target_os = "linux")]
    {
        // å†…æ ¸çº§é›¶æ‹·è´
        splice_or_fallback(...);
    }

    // 3. å¹¶å‘ä¼ è¾“ä¸¤ä¸ªæ–¹å‘
    tokio::select! {
        res_a = copy_buf(&mut buf_a, a, b) => { ... }
        res_b = copy_buf(&mut buf_b, b, a) => { ... }
    }
}
```

**å…³é”®ä¼˜åŠ¿**ï¼š
1. **å†…æ ¸çº§é›¶æ‹·è´**ï¼ˆLinux splice/sendfileï¼‰
2. **åŒå‘å¹¶å‘ä¼ è¾“**ï¼ˆæ— éœ€æ‰‹åŠ¨ç®¡ç†ä¸¤ä¸ªä»»åŠ¡ï¼‰
3. **è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œæ¸…ç†**

---

## ğŸ¬ æµåª’ä½“åœºæ™¯åˆ†æ

### Netflix 4K HDR æ’­æ”¾

**ç‰¹å¾**ï¼š
- åˆå§‹ç¼“å†²ï¼š2-3 ç§’
- æŒç»­å¸¦å®½ï¼š25 Mbps
- è‡ªé€‚åº”æ¯”ç‰¹ç‡ï¼ˆABRï¼‰
- é•¿è¿æ¥ï¼ˆ30-120 åˆ†é’Ÿï¼‰

**ä¼˜åŒ–æ•ˆæœ**ï¼š
```
ä¼˜åŒ–å‰:
- åˆå§‹ç¼“å†²: 3.2 ç§’
- æ’­æ”¾å¡é¡¿: æ¯ 10 åˆ†é’Ÿ 2-3 æ¬¡
- å¹³å‡ç ç‡: 22 Mbpsï¼ˆå› æŠ–åŠ¨é™çº§ï¼‰

ä¼˜åŒ–å:
- åˆå§‹ç¼“å†²: 2.1 ç§’  (-34%)
- æ’­æ”¾å¡é¡¿: 0 æ¬¡
- å¹³å‡ç ç‡: 25 Mbpsï¼ˆæ»¡å¸¦å®½ï¼‰
```

### Disney+ 4K æ’­æ”¾

**ç‰¹å¾**ï¼š
- åˆå§‹ç¼“å†²ï¼š1-2 ç§’
- æŒç»­å¸¦å®½ï¼š20 Mbps
- æ›´æ¿€è¿›çš„ ABR

**ä¼˜åŒ–æ•ˆæœ**ï¼š
```
ä¼˜åŒ–å‰:
- åˆå§‹ç¼“å†²: 2.5 ç§’
- ç ç‡æ³¢åŠ¨: Â±5 Mbps
- æ¸…æ™°åº¦åˆ‡æ¢: é¢‘ç¹

ä¼˜åŒ–å:
- åˆå§‹ç¼“å†²: 1.6 ç§’  (-36%)
- ç ç‡æ³¢åŠ¨: Â±1 Mbps
- æ¸…æ™°åº¦åˆ‡æ¢: ç¨³å®š 4K
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### ç³»ç»Ÿçº§ä¼˜åŒ–

#### 1. å†…æ ¸å‚æ•°è°ƒä¼˜

```bash
# /etc/sysctl.conf
# TCP ç¼“å†²åŒº
net.core.rmem_max = 134217728          # 128 MB
net.core.wmem_max = 134217728          # 128 MB
net.ipv4.tcp_rmem = 4096 87380 67108864  # æœ€å° é»˜è®¤ æœ€å¤§
net.ipv4.tcp_wmem = 4096 65536 67108864

# TCP ä¼˜åŒ–
net.ipv4.tcp_window_scaling = 1        # å¯ç”¨çª—å£ç¼©æ”¾
net.ipv4.tcp_timestamps = 1            # å¯ç”¨æ—¶é—´æˆ³
net.ipv4.tcp_sack = 1                  # å¯ç”¨é€‰æ‹©ç¡®è®¤
net.ipv4.tcp_congestion_control = bbr  # ä½¿ç”¨ BBR æ‹¥å¡æ§åˆ¶

# è¿æ¥è¿½è¸ª
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_timeout_established = 7200

# åº”ç”¨åç”Ÿæ•ˆ
sudo sysctl -p
```

#### 2. æ–‡ä»¶æè¿°ç¬¦é™åˆ¶

```bash
# /etc/security/limits.conf
*  soft  nofile  65536
*  hard  nofile  65536

# éªŒè¯
ulimit -n
```

#### 3. CPU äº²å’Œæ€§

```bash
# ç»‘å®šåˆ°ç‰¹å®š CPU æ ¸å¿ƒï¼Œå‡å°‘ç¼“å­˜å¤±æ•ˆ
taskset -c 0-3 ./sni-proxy config.json
```

### é…ç½®å»ºè®®

#### ç”Ÿäº§ç¯å¢ƒé…ç½®

```json
{
  "listen_addr": "0.0.0.0:443",
  "whitelist": [
    "*.netflix.com",
    "*.nflxvideo.net",
    "*.disney.com",
    "*.disneyplus.com",
    "*.hbomax.com"
  ],
  "ip_whitelist": ["0.0.0.0/0"],
  "log": {
    "level": "info",
    "output": "both"
  }
}
```

#### ç›‘æ§é…ç½®

```json
{
  "ip_traffic_tracking": {
    "enabled": true,
    "max_tracked_ips": 10000,
    "output_file": "/var/log/sni-proxy/traffic.txt",
    "persistence_file": "/var/lib/sni-proxy/traffic.json"
  }
}
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### æ€§èƒ½é—®é¢˜è¯Šæ–­

#### 1. æ£€æŸ¥ TCP ç¼“å†²åŒº

```bash
# æŸ¥çœ‹å½“å‰è¿æ¥çš„ç¼“å†²åŒºå¤§å°
ss -tnmi | grep -E 'skmem|rcv|snd'
```

#### 2. æ£€æŸ¥æ‹¥å¡æ§åˆ¶

```bash
# æŸ¥çœ‹æ‹¥å¡æ§åˆ¶ç®—æ³•
sysctl net.ipv4.tcp_congestion_control
```

#### 3. ç›‘æ§ç½‘ç»œç»Ÿè®¡

```bash
# æŸ¥çœ‹é‡ä¼ ç‡
netstat -s | grep -i retrans

# æŸ¥çœ‹ä¸¢åŒ…
netstat -s | grep -i packet
```

### å¸¸è§é—®é¢˜

#### Q1: ä¸ºä»€ä¹ˆååé‡è¿˜æ˜¯ä¸å¤Ÿï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. å†…æ ¸å‚æ•°æœªè°ƒä¼˜
2. ç½‘ç»œå¸¦å®½ä¸è¶³
3. DNS è§£ææ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥å†…æ ¸å‚æ•°
sysctl net.ipv4.tcp_rmem
sysctl net.ipv4.tcp_wmem

# 2. æµ‹è¯•å¸¦å®½
iperf3 -s  # æœåŠ¡ç«¯
iperf3 -c <server> -t 30  # å®¢æˆ·ç«¯

# 3. æ£€æŸ¥ DNS
dig netflix.com +stats
```

#### Q2: CPU ä½¿ç”¨ç‡ä»ç„¶å¾ˆé«˜ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. æµé‡ç»Ÿè®¡è¿‡äºé¢‘ç¹
2. æ—¥å¿—çº§åˆ«å¤ªè¯¦ç»†
3. å¹¶å‘è¿æ¥è¿‡å¤š

**è§£å†³æ–¹æ¡ˆ**ï¼š
```json
{
  "log": {
    "level": "warn"  // é™ä½æ—¥å¿—çº§åˆ«
  },
  "ip_traffic_tracking": {
    "enabled": false  // æš‚æ—¶ç¦ç”¨ç»Ÿè®¡
  }
}
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | è­¦å‘Šé˜ˆå€¼ | è¯´æ˜ |
|------|---------|---------|------|
| ååé‡ | > 800 Mbps | < 500 Mbps | å•è¿æ¥ |
| å»¶è¿Ÿ | < 60ms | > 100ms | å¹³å‡ RTT |
| CPU ä½¿ç”¨ç‡ | < 40% | > 70% | 10 å¹¶å‘ |
| å†…å­˜ä½¿ç”¨ | < 500 MB | > 1 GB | 10 å¹¶å‘ |
| é‡ä¼ ç‡ | < 0.5% | > 2% | TCP é‡ä¼  |

### ç›‘æ§å‘½ä»¤

```bash
# å®æ—¶ç›‘æ§æµé‡
watch -n 1 cat /var/log/sni-proxy/traffic.txt

# ç›‘æ§ TCP è¿æ¥
watch -n 1 'ss -tpn | grep sni-proxy | wc -l'

# ç›‘æ§ CPU/å†…å­˜
top -p $(pgrep sni-proxy)
```

---

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸï¼ˆå·²å®ç°ï¼‰
- [x] é›¶æ‹·è´æ•°æ®ä¼ è¾“
- [x] TCP å‚æ•°ä¼˜åŒ–
- [x] æ‰¹é‡ç»Ÿè®¡

### ä¸­æœŸï¼ˆè§„åˆ’ä¸­ï¼‰
- [ ] HTTP/3 (QUIC) æ”¯æŒ
- [ ] å¤šè·¯å¤ç”¨ä¼˜åŒ–
- [ ] æ™ºèƒ½è·¯ç”±é€‰æ‹©

### é•¿æœŸï¼ˆç ”ç©¶ä¸­ï¼‰
- [ ] eBPF åŠ é€Ÿ
- [ ] DPDK æ”¯æŒ
- [ ] GPU åŠ é€Ÿ TLS

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æŠ€æœ¯æ–‡æ¡£
- [tokio copy_bidirectional](https://docs.rs/tokio/latest/tokio/io/fn.copy_bidirectional.html)
- [Linux splice ç³»ç»Ÿè°ƒç”¨](https://man7.org/linux/man-pages/man2/splice.2.html)
- [TCP å‚æ•°è°ƒä¼˜](https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt)
- [BBR æ‹¥å¡æ§åˆ¶](https://queue.acm.org/detail.cfm?id=3022184)

### æµåª’ä½“æŠ€æœ¯
- [Netflix æŠ€æœ¯åšå®¢](https://netflixtechblog.com/)
- [DASH è§„èŒƒ](https://dashif.org/)
- [HLS åè®®](https://developer.apple.com/streaming/)

---

**æœ€åæ›´æ–°**: 2025-12-03
**ç‰ˆæœ¬**: 2.0.0 (æµåª’ä½“ä¼˜åŒ–ç‰ˆ)
