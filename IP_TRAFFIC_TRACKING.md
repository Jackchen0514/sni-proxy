# IP 流量追踪功能

本文档介绍 SNI 代理服务器的 IP 流量追踪功能，用于统计 **IP 白名单中的 IP** 的流量使用情况。

## 功能概述

IP 流量追踪功能可以帮助你：
- 📊 统计每个 IP 的累积流量（上传 + 下载）
- 🔢 统计每个 IP 的连接次数
- 📈 查看 TOP N 流量使用排行
- 💾 使用 LRU 缓存限制内存占用

**重要提示**：该功能**仅统计 IP 白名单中的 IP**，不会统计所有连接的 IP。

## 配置方法

### 1. 启用 IP 流量追踪

在 `config.json` 中添加 `ip_traffic_tracking` 配置：

```json
{
  "listen_addr": "0.0.0.0:443",
  "whitelist": ["*.example.com"],

  "ip_whitelist": [
    "192.168.1.0/24",
    "10.0.0.0/8"
  ],

  "ip_traffic_tracking": {
    "enabled": true,
    "max_tracked_ips": 1000
  }
}
```

### 2. 配置参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | boolean | false | 是否启用 IP 流量追踪 |
| `max_tracked_ips` | number | 1000 | 最大跟踪的 IP 数量（使用 LRU 缓存） |

## 工作原理

### 统计范围

**仅统计 IP 白名单中的 IP**：

```
客户端连接
    ↓
1. IP 白名单检查
    ├─ 不在白名单 → 拒绝连接（不统计）
    └─ 在白名单中 → 允许连接
        ↓
    2. 记录连接 ✅
    3. 处理数据转发
    4. 统计流量 ✅（实时记录上传/下载字节数）
```

### 统计指标

对于每个 IP，追踪以下信息：

- **连接次数**: 该 IP 建立的总连接数
- **接收字节** (上传): 从客户端接收的数据量（实时统计）
- **发送字节** (下载): 发送给客户端的数据量（实时统计）
- **总流量**: 接收 + 发送

### 内存管理

使用 LRU (Least Recently Used) 缓存：
- 限制跟踪的 IP 数量
- 当达到上限时，自动淘汰最少使用的 IP
- 内存占用：约 `max_tracked_ips * 64 bytes`

**示例**：
```
max_tracked_ips = 1000
内存占用 ≈ 1000 * 64 bytes = 64 KB
```

## 日志输出

### 启动日志

启用 IP 流量追踪时，会显示：

```
[INFO] 配置 IP 流量追踪
  最大跟踪 IP 数量: 1000
[INFO] ✅ IP 流量追踪已启用
```

### 定期统计（每分钟）

服务会每分钟自动打印 TOP 10 流量统计：

```
[INFO] === IP 流量统计（TOP 10）===
[INFO] 排名 IP 地址                                      上传         下载         总流量      连接数
[INFO] ----------------------------------------------------------------------------------------------------
[INFO] 1    192.168.1.100                              1.25 GB      3.45 GB      4.70 GB      1523
[INFO] 2    192.168.1.101                              800.50 MB    2.10 GB      2.90 GB      856
[INFO] 3    192.168.1.102                              500.20 MB    1.50 GB      2.00 GB      432
[INFO] 4    10.0.0.50                                  200.10 MB    800.00 MB    1.00 GB      234
[INFO] 5    10.0.0.51                                  150.00 MB    450.00 MB    600.00 MB    156
[INFO] ----------------------------------------------------------------------------------------------------
[INFO] 当前跟踪 IP 数量: 45
```

### Debug 日志

当日志级别设置为 `debug` 时，会显示每个连接的记录：

```
[DEBUG] IP 192.168.1.100 连接计数 +1
[DEBUG] ✅ IP 192.168.1.100 通过白名单检查 (来自 192.168.1.100:54321)
```

## 使用场景

### 场景 1: 监控用户流量

**需求**：监控授权用户的流量使用情况

**配置**：
```json
{
  "ip_whitelist": [
    "192.168.1.100",  // 用户 A
    "192.168.1.101",  // 用户 B
    "192.168.1.102"   // 用户 C
  ],
  "ip_traffic_tracking": {
    "enabled": true,
    "max_tracked_ips": 100
  }
}
```

**效果**：每分钟查看这 3 个用户的流量使用情况

### 场景 2: 办公网络流量分析

**需求**：分析办公网络中各 IP 的流量使用

**配置**：
```json
{
  "ip_whitelist": [
    "192.168.0.0/16"  // 整个办公网段
  ],
  "ip_traffic_tracking": {
    "enabled": true,
    "max_tracked_ips": 500
  }
}
```

**效果**：追踪办公网段中活跃的 500 个 IP

### 场景 3: 公共服务流量监控

**需求**：监控公共服务的流量分布

**配置**：
```json
{
  "ip_whitelist": [
    "0.0.0.0/0"  // 允许所有 IP（不推荐生产环境）
  ],
  "ip_traffic_tracking": {
    "enabled": true,
    "max_tracked_ips": 10000
  }
}
```

**效果**：追踪最活跃的 10000 个 IP

## 性能影响

### 性能开销

| 操作 | CPU 开销 | 内存开销 |
|------|---------|---------|
| 连接记录 | < 0.1% | 极低 |
| 流量统计 | < 0.5% | 低 (64 bytes/IP) |
| TOP N 查询 | < 1% | 低 |

### 优化建议

1. **合理设置 `max_tracked_ips`**
   - 小规模：100-500
   - 中等规模：500-2000
   - 大规模：2000-10000

2. **仅在需要时启用**
   - 如果不需要流量统计，设置 `enabled: false`
   - 禁用时几乎零开销

3. **日志级别**
   - 生产环境：`info` 级别（每分钟一次统计）
   - 调试环境：`debug` 级别（显示每个连接）

## 常见问题

### Q: 为什么只统计 IP 白名单中的 IP？

A: 这样设计有几个好处：
1. **减少内存占用**：只跟踪授权用户
2. **更有针对性**：关注真正使用服务的用户
3. **提高性能**：不需要为所有连接记录流量
4. **隐私保护**：不记录未授权访问者的信息

### Q: 如何统计所有 IP 的流量？

A: 将 IP 白名单设置为允许所有 IP（不推荐生产环境）：

```json
{
  "ip_whitelist": ["0.0.0.0/0"],
  "ip_traffic_tracking": {
    "enabled": true,
    "max_tracked_ips": 10000
  }
}
```

⚠️ **警告**：这会增加内存占用和性能开销。

### Q: `max_tracked_ips` 达到上限后会怎样？

A: 使用 LRU 缓存机制：
- 自动淘汰最少使用的 IP
- 不会影响服务性能
- 活跃 IP 的数据会保留

### Q: 如何导出流量统计数据？

A: 目前有两种方式：
1. 查看日志文件中的定期统计
2. 未来可以添加 HTTP API 查询接口（待实现）

### Q: 服务重启后数据会丢失吗？

A: 是的，目前统计数据存储在内存中，重启后会清空。
   - 未来可以添加持久化功能（待实现）

### Q: 流量统计是实时的吗？

A: 是的，流量统计是实时的：
   - 每次数据传输都会立即更新统计数据
   - 使用原子操作保证线程安全
   - 统计报告每分钟自动打印一次

## 配置示例

### 示例 1: 最小配置

```json
{
  "listen_addr": "0.0.0.0:443",
  "whitelist": ["*.example.com"],
  "ip_whitelist": ["192.168.1.0/24"],
  "ip_traffic_tracking": {
    "enabled": true
  }
}
```

### 示例 2: 完整配置

```json
{
  "listen_addr": "0.0.0.0:443",
  "whitelist": [
    "*.anthropic.com",
    "claude.ai"
  ],
  "ip_whitelist": [
    "127.0.0.0/8",
    "192.168.0.0/16",
    "10.0.0.0/8"
  ],
  "ip_traffic_tracking": {
    "enabled": true,
    "max_tracked_ips": 1000
  },
  "log": {
    "level": "info",
    "output": "both",
    "file_path": "/var/log/sni-proxy/sni-proxy.log"
  }
}
```

### 示例 3: 禁用流量追踪

```json
{
  "listen_addr": "0.0.0.0:443",
  "whitelist": ["*.example.com"],
  "ip_whitelist": ["192.168.1.0/24"],
  "ip_traffic_tracking": {
    "enabled": false
  }
}
```

或者直接省略 `ip_traffic_tracking` 字段（默认禁用）：

```json
{
  "listen_addr": "0.0.0.0:443",
  "whitelist": ["*.example.com"],
  "ip_whitelist": ["192.168.1.0/24"]
}
```

## 未来计划

- [x] 实时流量统计（上传/下载字节数）✅ 已完成
- [ ] HTTP API 查询接口
- [ ] 数据持久化到文件
- [ ] 按时间段统计（每小时/每天）
- [ ] 导出为 CSV/JSON 格式
- [ ] Prometheus metrics 支持
- [ ] Web Dashboard 可视化

## 参考配置文件

- `config-ip-traffic-tracking.json` - IP 流量追踪完整配置示例

## 相关文档

- [IP_WHITELIST.md](IP_WHITELIST.md) - IP 白名单功能文档
- [README.md](README.md) - 项目主文档
